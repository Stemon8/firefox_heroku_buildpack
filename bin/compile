BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
VERSION_FIREFOX=82.0.3
ARCHIVE_NAME_FIREFOX=firefox
FILE_NAME_FIREFOX=${ARCHIVE_NAME_FIREFOX}-${VERSION_FIREFOX}_3.tar.bz2
BUILDPACK_FIREFOX_PACKAGE="https://ftp.mozilla.org/pub/firefox/releases/${VERSION_FIREFOX}/linux-x86_64/en-US/firefox-${VERSION_FIREFOX}.tar.bz2"
LANG=en-US



# Install Firefox
mkdir -p $CACHE_DIR
if ! [ -e $CACHE_DIR/$FILE_NAME_FIREFOX ]; then
  echo "Fetching Firefox package from ${BUILDPACK_FIREFOX_PACKAGE}"
  curl $BUILDPACK_FIREFOX_PACKAGE -L -o $CACHE_DIR/$FILE_NAME_FIREFOX
fi

echo "Extracting Firefox binaries to ${BUILD_DIR}/vendor/${ARCHIVE_NAME_FIREFOX}"
mkdir -p $CACHE_DIR/$ARCHIVE_NAME_FIREFOX
mkdir -p $BUILD_DIR/vendor
tar xf $CACHE_DIR/$FILE_NAME_FIREFOX -C $CACHE_DIR
mv $CACHE_DIR/$ARCHIVE_NAME_FIREFOX $BUILD_DIR/vendor/

echo "Setting paths"
mkdir -p $BUILD_DIR/.profile.d
cat <<EOF >$BUILD_DIR/.profile.d/000_apt.sh
export PATH="$BUILD_DIR/.apt/usr/bin:$PATH:\$BUILD_DIR/vendor/firefox:\$PATH"
export TMPDIR="\$BUILD_DIR/tmp"
export LD_LIBRARY_PATH="$BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu:$BUILD_DIR/.apt/usr/lib/i386-linux-gnu:$BUILD_DIR/.apt/usr/lib:\$BUILD_DIR/vendor/firefox:\$LIBRARY_PATH"
export LIBRARY_PATH="$BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu:$BUILD_DIR/.apt/usr/lib/i386-linux-gnu:$BUILD_DIR/.apt/usr/lib:\$BUILD_DIR/vendor/firefox:\$LIBRARY_PATH"
EOF

export PATH="$BUILD_DIR/.apt/usr/bin:$PATH:\$BUILD_DIR/vendor/firefox:\$PATH"
export TMPDIR="\$BUILD_DIR/tmp"
export LD_LIBRARY_PATH="$BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu:$BUILD_DIR/.apt/usr/lib/i386-linux-gnu:$BUILD_DIR/.apt/usr/lib:\$BUILD_DIR/vendor/firefox:\$LIBRARY_PATH"
export LIBRARY_PATH="$BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu:$BUILD_DIR/.apt/usr/lib/i386-linux-gnu:$BUILD_DIR/.apt/usr/lib:\$BUILD_DIR/vendor/firefox:\$LIBRARY_PATH"

#export | grep -E -e ' (PATH|LD_LIBRARY_PATH|LIBRARY_PATH|INCLUDE_PATH|CPATH|CPPPATH|PKG_CONFIG_PATH)='  > "$LP_DIR/export"